/*!
 * A Node.JS library for the M-Pesa Mozambique API
 *
 * @author Ivan Ruby <https://ivanruby.com>
 * @license MIT
 */
axios=require("axios"),NodeRSA=require("node-rsa"),module.exports=function(i){if(this._public_key=i.public_key,this._api_host=i.api_host,this._api_key=i.api_key,this._origin=i.origin,this._service_provider_code=i.service_provider_code,this._initiator_identifier=i.initiator_identifier,this._security_credential=i.security_credential,this._validation_errors=[],this._isValidated=function(i,e){switch(this._validation_errors=[],i){case"config":this._api_host&&""!==this._api_host||this._validation_errors.push("API Host "),this._api_key&&""!==this._api_key||this._validation_errors.push("API Key "),this._initiator_identifier&&""!==this._initiator_identifier||this._validation_errors.push("Initiator Identifier "),this._origin&&""!==this._origin||this._validation_errors.push("Origin "),this._public_key&&""!==this._public_key||this._validation_errors.push("Public key "),this._security_credential&&""!==this._security_credential||this._validation_errors.push("Security credentials "),this._service_provider_code&&""!==this._service_provider_code||this._validation_errors.push("Service provider code ");break;case"c2b":e.amount&&""!==e.amount&&isNumber(parseFloat(e.amount))||this._validation_errors.push("C2B Amount "),e.msisdn&&""!==e.msisdn&&isValidMSISDN(e.msisdn)||this._validation_errors.push("C2B MSISDN "),e.reference&&""!==e.reference||this._validation_errors.push("C2B Reference "),e.third_party_reference&&""!==e.third_party_reference||this._validation_errors.push("C2B 3rd-party Reference ");break;case"query":e.query_reference&&""!==e.query_reference||this._validation_errors.push("Query Reference "),e.third_party_reference&&""!==e.third_party_reference||this._validation_errors.push("Query 3rd-party Reference ");break;case"reversal":e.amount&&""!==e.amount&&isNumber(parseFloat(e.amount))||this._validation_errors.push("C2B Amount "),e.transaction_id&&""!==e.transaction_id||this._validation_errors.push("C2B Amount "),e.third_party_reference&&""!==e.third_party_reference||this._validation_errors.push("C2B 3rd-party Reference ")}return!(this._validation_errors.length>0)},this._getBearerToken=function(){if(this._isValidated("config",{}))return certificate="-----BEGIN PUBLIC KEY-----\n"+this._public_key+"\n-----END PUBLIC KEY-----",public_key=new NodeRSA,public_key.setOptions({encryptionScheme:"pkcs1"}),public_key.importKey(Buffer.from(certificate),"public"),token=public_key.encrypt(Buffer.from(this._api_key)),"Bearer "+Buffer.from(token).toString("base64");throw Error("Missing or invalid configuration parameters: "+this._validation_errors.toString())},this._request_headers={},this.c2b=async function(i){if(this._isValidated("c2b",i))return request={method:"post",url:"https://"+this._api_host+":18352/ipg/v1x/c2bPayment/singleStage/",data:{input_ServiceProviderCode:this._service_provider_code,input_CustomerMSISDN:i.msisdn,input_Amount:parseFloat(i.amount).toFixed(2),input_TransactionReference:i.reference,input_ThirdPartyReference:i.third_party_reference},headers:this._request_headers},await new Promise(function(i,e){axios(request).then(function(e){i(e)}).catch(function(i){e(i)})});throw Error("Missing or invalid configuration parameters: "+this._validation_errors.toString())},this.query=async function(i){if(this._isValidated("query",i))return request={method:"get",url:"https://"+this._api_host+":18353/ipg/v1x/queryTransactionStatus/?input_QueryReference="+i.query_reference+"&input_ServiceProviderCode="+this._service_provider_code+"&input_ThirdPartyReference="+i.third_party_reference,headers:this._request_headers},await new Promise(function(i,e){axios(request).then(function(e){i(e.data)}).catch(function(i){e(i.data)})});throw Error("Missing or invalid configuration parameters: "+this._validation_errors.toString())},this.reverse=function(i){if(this._isValidated("reversal",i))return request={method:"put",url:"https://"+this._api_host+":18354/ipg/v1x/reversal/",data:{input_ReversalAmount:Number.parseFloat(i.amount).toFixed(2),input_TransactionID:i.transaction_id,input_ThirdPartyReference:i.third_party_reference,input_ServiceProviderCode:this._service_provider_code,input_InitiatorIdentifier:this._initiator_identifier,input_SecurityCredential:this._security_credential},headers:this.request_headers},new Promise(function(i,e){axios(request).then(function(e){i(e.data)}).catch(function(i){e(i.data)})});throw Error("Missing or invalid configuration parameters: "+this._validation_errors.toString())},!this._isValidated("config",{}))throw Error("Missing or invalid configuration parameters: "+this._validation_errors.toString());this._request_headers={"Content-Type":"application/json",Origin:this._origin,Authorization:this._getBearerToken()}};