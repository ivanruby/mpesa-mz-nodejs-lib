/*!
 * A Node.JS library for the M-Pesa Mozambique API
 *
 * @author Ivan Ruby <https://ivanruby.com>
 * @license MIT
 */
axios=require("axios"),NodeRSA=require("node-rsa"),module.exports=function(i){this._public_key=i.public_key,this._api_host=i.api_host,this._api_key=i.api_key,this._origin=i.origin,this._service_provider_code=i.service_provider_code,this._initiator_identifier=i.initiator_identifier,this._security_credential=i.security_credential,this._getBearerToken=function(){return certificate="-----BEGIN PUBLIC KEY-----\n"+this._public_key+"\n-----END PUBLIC KEY-----",public_key=new NodeRSA,public_key.setOptions({encryptionScheme:"pkcs1"}),public_key.importKey(Buffer.from(certificate),"public"),token=public_key.encrypt(Buffer.from(this._api_key)),"Bearer "+Buffer.from(token).toString("base64")},this._request_headers={"Content-Type":"application/json",Origin:this._origin,Authorization:this._getBearerToken()},this._config_errors=[],this._withValidConfig=function(){return this._config_errors=[],this._api_host&&""!==this._api_host||this._config_errors.push("API Host "),this._api_key&&""!==this._api_key||this._config_errors.push("API Key "),this._initiator_identifier&&""!==this._initiator_identifier||this._config_errors.push("Initiator Identifier "),this._origin&&""!==this._origin||this._config_errors.push("Origin "),this._public_key&&""!==this._public_key||this._config_errors.push("Public key "),this._security_credential&&""!==this._security_credential||this._config_errors.push("Security credentials "),this._service_provider_code&&""!==this._service_provider_code||this._config_errors.push("Service provider code "),!(this._config_errors.length>0)},this.c2b=async function(i){if(this._withValidConfig())return request={method:"post",url:"https://"+this._api_host+":18352/ipg/v1x/c2bPayment/singleStage/",data:{input_ServiceProviderCode:this._service_provider_code,input_CustomerMSISDN:i.msisdn,input_Amount:parseFloat(i.amount).toFixed(2),input_TransactionReference:i.reference,input_ThirdPartyReference:i.third_party_reference},headers:this._request_headers},await new Promise(function(i,e){axios(request).then(function(e){i(e)}).catch(function(i){e(i)})});throw Error("Missing or invalid configuration parameters: "+this._config_errors.toString())},this.query=async function(i){if(this._withValidConfig())return request={method:"get",url:"https://"+this._api_host+":18353/ipg/v1x/queryTransactionStatus/?input_QueryReference="+i.query_reference+"&input_ServiceProviderCode="+this._service_provider_code+"&input_ThirdPartyReference="+i.third_party_reference,headers:this._request_headers},await new Promise(function(i,e){axios(request).then(function(e){i(e.data)}).catch(function(i){e(i.data)})});throw Error("Missing or invalid configuration parameters: "+this._config_errors.toString())},this.reverse=function(i){if(this._withValidConfig())return request={method:"put",url:"https://"+this._api_host+":18354/ipg/v1x/reversal/",data:{input_ReversalAmount:Number.parseFloat(i.amount).toFixed(2),input_TransactionID:i.transaction_id,input_ThirdPartyReference:i.third_party_reference,input_ServiceProviderCode:this._service_provider_code,input_InitiatorIdentifier:this._initiator_identifier,input_SecurityCredential:this._security_credential},headers:this.request_headers},new Promise(function(i,e){axios(request).then(function(e){i(e.data)}).catch(function(i){e(i.data)})});throw Error("Missing or invalid configuration parameters: "+this._config_errors.toString())}};